<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #e0f2fe 0%, #fce4ec 100%);
    }
    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9 0%, #ec4899 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #0284c7 0%, #db2777 100%);
      transform: translateY(-1px);
    }
    .btn-success {
      background-color: #10b981;
    }
    .btn-success:hover {
      background-color: #059669;
    }
    .btn-warning {
      background-color: #f59e0b;
    }
    .btn-warning:hover {
      background-color: #d97706;
    }
    .btn-danger {
      background-color: #ef4444;
    }
    .btn-danger:hover {
      background-color: #dc2626;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .toast.show {
      transform: translateX(0);
    }
    .toast.success { background-color: #059669; }
    .toast.error { background-color: #dc2626; }
    .toast.info { background-color: #0891b2; }
    .stat-box {
      background: white;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      color: #6b7280;
      font-size: 14px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
    }
    .status-approved {
      background-color: #d1fae5;
      color: #065f46;
    }
    .status-revision {
      background-color: #fed7aa;
      color: #92400e;
    }
    .status-late {
      background-color: #fee2e2;
      color: #7f1d1d;
    }
    .progress-bar {
      background-color: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      height: 8px;
    }
    .progress-fill {
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      height: 100%;
      transition: width 0.3s ease;
    }
    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background-color: #e0e7ff;
      color: #4f46e5;
    }
  </style>
 </head>
 <body class="gradient-bg min-h-full">
  <div id="app" class="min-h-full">
   <header class="bg-white shadow-md border-b-4 border-pink-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
       <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-pink-400 rounded-full flex items-center justify-center shadow-md">
        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
       </div>
       <div>
        <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
        <p class="text-lg text-blue-600">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏ä‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ô‡∏∏‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå 56 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡πà‡∏≤‡∏ô</p>
        <p class="text-sm text-gray-600">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</p>
       </div>
      </div>
      <div class="flex items-center space-x-4">
       <div id="user-info" class="text-right">
        <p class="text-sm text-gray-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        <p id="current-user" class="font-semibold text-blue-600">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</p>
        <p id="current-role" class="text-xs text-gray-500"></p>
       </div>
       <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
     </div>
    </div>
   </header>

   <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 card-shadow">
     <div class="text-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <p class="text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
     </div>
     <form id="login-form" class="space-y-4">
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
       <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="teacher / academic / admin" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
       <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="123" required>
      </div>
      <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
     </form>
     <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
      <p class="font-semibold text-blue-900 mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö:</p>
      <p class="text-blue-800">üë®‚Äçüè´ teacher / 123</p>
      <p class="text-blue-800">üë®‚Äçüíº academic / 123</p>
      <p class="text-blue-800">üëî admin / 123</p>
     </div>
    </div>
   </div>

   <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
    <div class="bg-white rounded-xl card-shadow mb-8 overflow-hidden">
     <div id="nav-tabs" class="flex flex-wrap">
      <button id="tab-upload" class="tab-btn flex-1 px-6 py-4 font-semibold text-center border-b-4 border-blue-500 bg-blue-50 teacher">üì§ ‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</button>
      <button id="tab-dashboard" class="tab-btn flex-1 px-6 py-4 font-semibold text-center border-b-4 border-transparent hover:bg-gray-50">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
      <button id="tab-review" class="tab-btn flex-1 px-6 py-4 font-semibold text-center border-b-4 border-transparent hover:bg-gray-50 academic admin hidden">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô</button>
      <button id="tab-approve" class="tab-btn flex-1 px-6 py-4 font-semibold text-center border-b-4 border-transparent hover:bg-gray-50 admin hidden">üìã ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ú‡∏ô</button>
     </div>
    </div>

    <!-- Upload Tab -->
    <div id="upload-tab" class="tab-content">
     <div class="bg-white rounded-xl card-shadow p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6">‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
      <form id="upload-form" class="space-y-6">
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</label>
        <input type="text" id="teacher-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
       </div>
       <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</label>
        <select id="subject-group" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
         <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</option>
         <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
         <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
         <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞">‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
         <option value="‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
         <option value="‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
        </select>
       </div>

       <div id="plans-container"></div>

       <button type="submit" id="submit-btn" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</button>
      </form>
     </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content hidden">
     <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="stat-box">
       <div class="stat-label">‡πÅ‡∏ú‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
       <div class="stat-number" style="color: #0ea5e9;" id="stat-total">0</div>
      </div>
      <div class="stat-box">
       <div class="stat-label">‡∏Ñ‡∏£‡πà‡∏≥‡∏Ñ‡∏£‡∏ß‡∏ç</div>
       <div class="stat-number" style="color: #10b981;" id="stat-approved">0</div>
      </div>
      <div class="stat-box">
       <div class="stat-label">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
       <div class="stat-number" style="color: #f59e0b;" id="stat-revision">0</div>
      </div>
      <div class="stat-box">
       <div class="stat-label">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>
       <div class="stat-number" style="color: #8b5cf6;" id="stat-pending">0</div>
      </div>
     </div>

     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-white rounded-xl card-shadow p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
       <canvas id="status-chart" height="100"></canvas>
      </div>
      <div class="bg-white rounded-xl card-shadow p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</h3>
       <canvas id="subject-chart" height="100"></canvas>
      </div>
     </div>

     <div class="bg-white rounded-xl card-shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="border-b-2 border-gray-200">
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
         </tr>
        </thead>
        <tbody id="plans-table-body">
        </tbody>
       </table>
       <div id="no-plans-msg" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</div>
      </div>
     </div>
    </div>

    <!-- Review Tab (Academic) -->
    <div id="review-tab" class="tab-content hidden">
     <div class="bg-white rounded-xl card-shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="border-b-2 border-gray-200">
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
         </tr>
        </thead>
        <tbody id="review-table-body">
        </tbody>
       </table>
       <div id="no-review-msg" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>
      </div>
     </div>
    </div>

    <!-- Approve Tab (Admin) -->
    <div id="approve-tab" class="tab-content hidden">
     <div class="bg-white rounded-xl card-shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="border-b-2 border-gray-200">
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
         </tr>
        </thead>
        <tbody id="approve-table-body">
        </tbody>
       </table>
       <div id="no-approve-msg" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>
     </div>
    </div>
   </main>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyXXd9q3QbEW0Rpn1OhraNqhGue10VRwL_AcjDMc_twyfBdY5YPJ-vX8zsIh7J1bdN4/exec';
    
    let currentUser = null;
    let currentRole = null;
    let currentPlans = 1;
    let allPlanData = [];
    let statusChart = null;
    let subjectChart = null;

    const roles = {
      teacher: { name: 'üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô', badge: 'teacher' },
      academic: { name: 'üë®‚Äçüíº ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£', badge: 'academic' },
      admin: { name: 'üëî ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', badge: 'admin' }
    };

    function initApp() {
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('upload-form').addEventListener('submit', handleUploadSubmit);
      
      document.getElementById('tab-upload').addEventListener('click', () => switchTab('upload'));
      document.getElementById('tab-dashboard').addEventListener('click', () => {
        switchTab('dashboard');
        loadDashboard();
      });
      document.getElementById('tab-review').addEventListener('click', () => {
        switchTab('review');
        loadReviewTab();
      });
      document.getElementById('tab-approve').addEventListener('click', () => {
        switchTab('approve');
        loadApproveTab();
      });

      renderPlansForm();
    }

    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (password === '123' && roles[username]) {
        currentUser = username;
        currentRole = username;
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('current-user').textContent = roles[username].name;
        document.getElementById('current-role').textContent = roles[username].badge;
        
        // Show/hide tabs based on role
        showTabsForRole(username);
        showUploadFormForRole(username);
      } else {
        showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
      }
    }

    function showTabsForRole(role) {
      // Hide all role-specific tabs
      document.querySelectorAll('.teacher').forEach(el => el.classList.remove('hidden'));
      document.querySelectorAll('.academic').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.admin').forEach(el => el.classList.add('hidden'));

      if (role === 'academic') {
        document.querySelectorAll('.academic').forEach(el => el.classList.remove('hidden'));
      } else if (role === 'admin') {
        document.querySelectorAll('.admin').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.academic').forEach(el => el.classList.remove('hidden'));
      }
    }

    function showUploadFormForRole(role) {
      const uploadTab = document.getElementById('upload-tab');
      if (role === 'teacher') {
        uploadTab.classList.remove('hidden');
      } else {
        uploadTab.classList.add('hidden');
      }
    }

    function handleLogout() {
      currentUser = null;
      currentRole = null;
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('login-form').reset();
      showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function renderPlansForm() {
      const container = document.getElementById('plans-container');
      let html = '';
      
      for (let i = 1; i <= currentPlans; i++) {
        html += `
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-semibold text-blue-800 mb-3">${i}. ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà ${i}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <input type="text" class="subject-code w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="‡∏ß21101" data-plan="${i}" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <input type="text" class="subject-name w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏°.1" data-plan="${i}" required>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÑ‡∏ü‡∏•‡πå PDF</label>
                <input type="file" class="pdf-file w-full px-3 py-2 border border-gray-300 rounded-lg" accept=".pdf" data-plan="${i}" required>
              </div>
            </div>
          </div>
        `;
      }
      
      html += `
        <div class="flex gap-3 mt-6">
          <button type="button" id="add-plan-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô</button>
          <button type="button" id="remove-plan-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">‚ûñ ‡∏•‡∏ö‡πÅ‡∏ú‡∏ô</button>
          <span class="px-4 py-2 bg-gray-100 rounded-lg">‡πÅ‡∏ú‡∏ô: <strong>${currentPlans}</strong>/5</span>
        </div>
      `;
      
      container.innerHTML = html;
      document.getElementById('add-plan-btn').addEventListener('click', addPlan);
      document.getElementById('remove-plan-btn').addEventListener('click', removePlan);
    }

    function addPlan() {
      if (currentPlans < 5) {
        currentPlans++;
        renderPlansForm();
      } else {
        showToast('‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡πÅ‡∏ú‡∏ô', 'info');
      }
    }

    function removePlan() {
      if (currentPlans > 1) {
        currentPlans--;
        renderPlansForm();
      } else {
        showToast('‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 1 ‡πÅ‡∏ú‡∏ô', 'info');
      }
    }

    function handleUploadSubmit(e) {
      e.preventDefault();
      
      const teacherName = document.getElementById('teacher-name').value;
      const subjectGroup = document.getElementById('subject-group').value;

      if (!teacherName || !subjectGroup) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      const plans = [];
      for (let i = 1; i <= currentPlans; i++) {
        const code = document.querySelector(`.subject-code[data-plan="${i}"]`).value;
        const name = document.querySelector(`.subject-name[data-plan="${i}"]`).value;
        const file = document.querySelector(`.pdf-file[data-plan="${i}"]`).files[0];

        if (!code || !name || !file) {
          showToast(`‡πÅ‡∏ú‡∏ô ${i} ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå`, 'error');
          return;
        }

        plans.push({ 
          subject_code: code, 
          subject_name: name, 
          pdf_file_name: file.name 
        });
      }

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.classList.add('loading');
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

      // ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Apps Script
      fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'submitPlan',
          teacher_name: teacherName,
          subject_group: subjectGroup,
          plans: plans
        })
      })
      .then(res => res.json())
      .then(result => {
        submitBtn.classList.remove('loading');
        submitBtn.textContent = '‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô';
        
        if (result.success) {
          // Add to local data
          allPlanData.push({
            id: Date.now(),
            teacher: teacherName,
            subject_group: subjectGroup,
            plans_count: currentPlans,
            submitted_date: new Date().toLocaleDateString('th-TH'),
            status: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à',
            comment: ''
          });

          showToast(`‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô ${currentPlans} ‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
          document.getElementById('upload-form').reset();
          currentPlans = 1;
          renderPlansForm();
        } else {
          showToast(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      })
      .catch(error => {
        submitBtn.classList.remove('loading');
        submitBtn.textContent = '‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô';
        showToast('Error: ' + error.message, 'error');
      });
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-50');
        btn.classList.add('border-transparent');
      });
      
      document.getElementById(`${tabName}-tab`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('border-blue-500', 'bg-blue-50');
    }

    function loadDashboard() {
      updateStats();
      renderCharts();
      renderPlansTable();
    }

    function updateStats() {
      const total = allPlanData.length;
      const approved = allPlanData.filter(p => p.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length;
      const revision = allPlanData.filter(p => p.status === '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°').length;
      const pending = allPlanData.filter(p => p.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à').length;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-approved').textContent = approved;
      document.getElementById('stat-revision').textContent = revision;
      document.getElementById('stat-pending').textContent = pending;
    }

    function renderCharts() {
      const statusCtx = document.getElementById('status-chart').getContext('2d');
      const statusCounts = {
        '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à': allPlanData.filter(p => p.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à').length,
        '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥': allPlanData.filter(p => p.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length,
        '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': allPlanData.filter(p => p.status === '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°').length
      };

      if (statusChart) statusChart.destroy();
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(statusCounts),
          datasets: [{
            data: Object.values(statusCounts),
            backgroundColor: ['#8b5cf6', '#10b981', '#f59e0b']
          }]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });

      const subjectCtx = document.getElementById('subject-chart').getContext('2d');
      const subjectCounts = {};
      allPlanData.forEach(p => {
        subjectCounts[p.subject_group] = (subjectCounts[p.subject_group] || 0) + 1;
      });

      if (subjectChart) subjectChart.destroy();
      subjectChart = new Chart(subjectCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(subjectCounts),
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô',
            data: Object.values(subjectCounts),
            backgroundColor: '#0ea5e9'
          }]
        },
        options: { responsive: true, maintainAspectRatio: true, indexAxis: 'y' }
      });
    }

    function renderPlansTable() {
      const tbody = document.getElementById('plans-table-body');
      const noMsg = document.getElementById('no-plans-msg');

      if (allPlanData.length === 0) {
        tbody.innerHTML = '';
        noMsg.style.display = 'block';
        return;
      }

      noMsg.style.display = 'none';
      tbody.innerHTML = allPlanData.map(plan => `
        <tr class="border-b border-gray-200 hover:bg-gray-50">
          <td class="px-4 py-3 text-sm">${plan.teacher}</td>
          <td class="px-4 py-3 text-sm">${plan.subject_group}</td>
          <td class="px-4 py-3 text-sm font-semibold">${plan.plans_count}/5</td>
          <td class="px-4 py-3 text-sm">${plan.submitted_date}</td>
          <td class="px-4 py-3 text-sm">
            <span class="status-badge status-${plan.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? 'approved' : plan.status === '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' ? 'revision' : 'pending'}">
              ${plan.status}
            </span>
          </td>
          <td class="px-4 py-3 text-sm">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(plan.plans_count / 5) * 100}%"></div>
            </div>
            <span class="text-xs text-gray-600">${Math.round((plan.plans_count / 5) * 100)}%</span>
          </td>
        </tr>
      `).join('');
    }

    function loadReviewTab() {
      const tbody = document.getElementById('review-table-body');
      const noMsg = document.getElementById('no-review-msg');
      const pending = allPlanData.filter(p => p.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à');

      if (pending.length === 0) {
        tbody.innerHTML = '';
        noMsg.style.display = 'block';
        return;
      }

      noMsg.style.display = 'none';
      tbody.innerHTML = pending.map(plan => `
        <tr class="border-b border-gray-200">
          <td class="px-4 py-3 text-sm">${plan.teacher}</td>
          <td class="px-4 py-3 text-sm">${plan.subject_group}</td>
          <td class="px-4 py-3 text-sm">${plan.plans_count}/5</td>
          <td class="px-4 py-3 text-sm">
            <span class="status-badge status-pending">${plan.status}</span>
          </td>
          <td class="px-4 py-3 text-sm">
            <button class="px-3 py-1 bg-yellow-500 text-white text-xs rounded mr-2" onclick="updateStatus(${plan.id}, '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°')">‡∏™‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="px-3 py-1 bg-blue-500 text-white text-xs rounded" onclick="updateStatus(${plan.id}, '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          </td>
        </tr>
      `).join('');
    }

    function loadApproveTab() {
      const tbody = document.getElementById('approve-table-body');
      const noMsg = document.getElementById('no-approve-msg');
      const reviewing = allPlanData.filter(p => p.status !== '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à' && p.status !== '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');

      if (reviewing.length === 0) {
        tbody.innerHTML = '';
        noMsg.style.display = 'block';
        return;
      }

      noMsg.style.display = 'none';
      tbody.innerHTML = reviewing.map(plan => `
        <tr class="border-b border-gray-200">
          <td class="px-4 py-3 text-sm">${plan.teacher}</td>
          <td class="px-4 py-3 text-sm">${plan.subject_group}</td>
          <td class="px-4 py-3 text-sm">${plan.plans_count}/5</td>
          <td class="px-4 py-3 text-sm">
            <span class="status-badge status-${plan.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô' ? 'approved' : 'revision'}">
              ${plan.status}
            </span>
          </td>
          <td class="px-4 py-3 text-sm">
            <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded text-xs" id="comment-${plan.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">
          </td>
          <td class="px-4 py-3 text-sm">
            <button class="px-3 py-1 btn-success text-white text-xs rounded mr-2" onclick="approveStatus(${plan.id}, '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class="px-3 py-1 btn-danger text-white text-xs rounded" onclick="rejectStatus(${plan.id})">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          </td>
        </tr>
      `).join('');
    }

    window.updateStatus = function(id, status) {
      const plan = allPlanData.find(p => p.id === id);
      if (plan) {
        plan.status = status;
        loadReviewTab();
        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }
    };

    window.approveStatus = function(id, status) {
      const plan = allPlanData.find(p => p.id === id);
      if (plan) {
        plan.status = status;
        plan.comment = document.getElementById(`comment-${id}`).value;
        loadApproveTab();
        loadDashboard();
        showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }
    };

    window.rejectStatus = function(id) {
      const plan = allPlanData.find(p => p.id === id);
      if (plan) {
        plan.status = '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
        plan.comment = document.getElementById(`comment-${id}`).value;
        loadApproveTab();
        loadDashboard();
        showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏ú‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'success');
      }
    };

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, type === 'error' ? 5000 : 3000);
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
 </body>
</html>
